<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Hello, World!</title>
</head>

<body>
	<ul>
		<li><a href="/rollback1">Rollback</a></li>
		<li><a wait-for-success href="/api/backup">Backup</a></li>
		<li><a wait-for-success href="/auth/checkLogin">Check log in</a></li>
		<li><a wait-for-success href="/auth/login">Log in</a></li>
		<li><a wait-for-success href="/auth/logout">Log out</a></li>
		<li><a wait-for-success
				href="https://mail.google.com/mail/u/0/#search/from:onboarding@resend.dev+subject:rollback confirmation">Retrieve
				Rollback Confirmation Link</a></li>
	</ul>

	<div style="position: fixed; top:0; right:0;">
		<h3>List all posts:</h3>
		<pre id="list"></pre>
	</div>

	<h3>Result:</h3>
	<pre id="result"></pre>

	<h3>add a post:</h3>
	<form id="addPost">
		<label for="title">title</label>
		<input type="text" id="title" name="title" required />
		<br>
		<label for="content">content</label>
		<textarea id="content" name="content"></textarea>
		<br>
		<label for="tags">tags</label>
		<input type="text" id="tags" name="tags" />
		<br>
		<label for="published">published</label>
		<input type="checkbox" id="published" name="published" />
		<br>
		<button type="submit"> Create Post </button>
	</form>

	<h3>post image:</h3>
	<form id="addImage">
		<input type="file" name="image" accept="image/png, image/gif, image/jpeg, image/webp, image/svg+xml" />
		<img width="100" id="preview" src="" />
		<input type="hidden" name="imageHash" id="imageHash" />
		Image Exits: <input type="checkbox" name='imageExists' disabled />
		<button type="submit" disabled>Upload Image</button>
	</form>

	<h3>Rollback:</h3>
	<form id="requestRollback" action="/api/requestRollback" method="POST">
		<input type="file" name="file" accept=".json" />
		<button type="submit">Rollback</button>
	</form>

	<script>
		async function imageHashBase64URL(arrayBuffer) {
			const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
			const base64 = btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
			return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
		};

		async function getUploadLink(hash) {
			const response = await fetch(`/api/uploadImageURL?path=${hash}?toDelete=true`);
			if (!response.ok)
				throw new Error("Error: retrieving upload url failed.");
			return await response.text();
		}

		async function updateImageForm(blob) {
			const arrayBuffer = await blob.arrayBuffer();
			const fileSrc = URL.createObjectURL(blob);
			document.querySelector("#preview").src = fileSrc;
			document.querySelector("#addImage button[type='submit']").setAttribute("disabled", true);
			let hash = await imageHashBase64URL(arrayBuffer);
			document.querySelector("#imageHash").value = hash;
			let exists = false;
			try {
				exists = (await fetch(`https://imagedelivery.net/Ckr7BDu4VxTAuei58W1b7Q/${hash}/public`, { method: 'HEAD' })).ok;
			} catch (e) { }
			emit("ok", "Image Checked");
			document.querySelector("#addImage input[name='imageExists']").checked = exists;
			document.querySelector("#addImage button[type='submit']").toggleAttribute("disabled", exists);
		}

		async function waitForOkError(href, timeout = 30000) {
			timeout += Date.now();
			const tab = window.open(href, '_blank');
			while (Date.now() < timeout) {
				try {
					if (
						tab.location.origin === window.location.origin &&
						tab.document?.body?.textContent?.match(/^(ok|error)\./)
					) {
						break;
					}
				} catch (e) { }
				await new Promise(r => setTimeout(r, 500));
			}
			if (Date.now() >= timeout)
				throw new Error("Error: Timed out waiting for tab to load expected content");
			emit('ok', tab.document.body.textContent);
			tab.close();
		}

		async function addPost(json) {
			const uid = Math.floor(Math.random() * 100000000); //todo do this in the worker?
			const response = await fetch('api/event/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ uid, ...json }),
			});
			if (response.ok)
				return emit('ok', JSON.stringify(await response.json()));
		 	throw new Error("Error creating post 1: " + response.statusText);
		}

		function emit(type, message) {
			dispatchEvent(new CustomEvent(type, { detail: { message } }));
		}

		const list = document.getElementById('list');
		const result = document.getElementById('result');

		let jsonList;

		(async function () {
			const resp = await fetch('/api/snap?name=all');
			jsonList = await resp.json();
			list.textContent = JSON.stringify(jsonList, null, 2);
			emit('ok', "init ok.");
		})(); 

		for (const el of document.querySelectorAll("a[wait-for-success]"))
			el.addEventListener('click', async function (e) {
				e.preventDefault();
				if (this.hasAttribute("waiting"))
					return alert("already trying to " + this.innerText.toLowerCase());
				this.setAttribute("waiting", "true");
				await waitForOkError(this.href);
				this.removeAttribute("waiting");
			});


		document.querySelector("input[name='file']").addEventListener('change', _ => result.textContent = "ok. file added");
		document.querySelector("input[name='image']").addEventListener('change', function () { updateImageForm(this.files[0]); });

		document.querySelector("#requestRollback").addEventListener("submit", async function (e) {
			e.preventDefault();
			const file = this.children[0].files[0];
			if (!file)
				return alert("Please select a file."), this.children[0].click();
			const resp = await fetch(this.action, {
				method: this.method,
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(JSON.parse(await file.text()))
			});
			if (resp.ok)
				return emit('ok', await resp.text());
			throw new Error("error. requesting rollback");
		});

		document.querySelector("#addPost").addEventListener("submit", async function (e) {
			e.preventDefault();
			await addPost(Object.fromEntries(new FormData(this)));
		});

		document.querySelector("#addImage").addEventListener("submit", async function (e) {
			e.preventDefault();
			const formData = new FormData(this);
			const uploadURL = await getUploadLink(formData.get("imageHash"));
			const uploadForm = new FormData();
			uploadForm.append("file", formData.get("image"));
			const response = await fetch(uploadURL, { method: "POST", body: uploadForm });
			if (!response.ok) 
				throw new Error("Error: adding image");
			result.textContent = "";
			emit('ok', 'Image Added to Image Server');
		});

		addEventListener("unhandledrejection", (e) => result.textContent  = e.reason);
		addEventListener("ok", (e) => result.textContent  = `ok. ${e.detail.message}`);
	</script>
</body>

</html>